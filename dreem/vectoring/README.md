# DREEM Vectoring Module
Contributor: Matty Allan, Yves Martin

## Purpose
- Filter out the reads with abnormaly high mutation rate (3 sigma interval)
- Convert mapped reads into mutation vectors


## Interface

### Command-line usage
```dreem-vectoring [options] -o path/to/out_dir -r {reference}.fasta -a {sample_1}.bam [{sample_2}.bam ... {sample_n}.bam]```
- [=1] ```-o / --out_dir```: output directory.
- [=1] ```-r / --ref```: Input fasta file path.
- [≥1] ```-a / --alignment```: Sequence alignment map file(s) generated by ```alignment```.
- [≥0] ```-c / --coords [ref | first | last]```: First and last coordinates for reference ref (creates one mutational profile); using 0 for last is shorthand for the last coordinate of the sequnce, -1 for the second-to-last, and so on.
- [≥0] ```-p / --primers [ref | fwd | rev]```: Forward and reverse primers for reference ref (creates one mutational profile)
- [≤1] ```-f / --fill```: For every reference in ```reference.fasta``` that was not explicitly specified using a ```-c``` or ```-p``` option, create a mutational profile for the entire sequence. Note: if none of ```-c```, ```-p``` or ```--fill``` are given, then no mutational profiles will be generated.
- [≤1] ```-P / --parallel```: Parallelize the processing of mutational ```profiles``` or process each profile in series and parallelize processing ```reads``` within each profile, turn all paralleization ```off```, or (default) ```auto```matically choose "reads" if processing 1 profile, otherwise "profiles".
- [≤1] ```-n / --num_vectors```: Limit the number of vectors in each batch to ```n``` (positive integer). Default is no limit. If ```b``` is also given, the batch will be capped by whichever limit is reached first.
- [≤1] ```-b / --num_bytes```: Limit the number of bytes in each batch to ```b``` (positive integer). Default is no limit. If ```n``` is also given, the batch will be capped by whichever limit is reached first.

### Input Files
- [=1] ```path/to/{reference}.fasta``` Sequence record file that contains the names and sequences of all references.
- [≥1] ```path/to/{sample}.bam``` Sequence alignment map file(s) generated by ```alignment```. Multiple files can be specified, and they do need to be in the same directory. Note that for every ```{sample}.bam``` file, a BAM index file with the same name (i.e. ```{sample}.bam.bai```) must be present in the same directory; this file is generated automatically near the end of ```alignment```. If the BAM index file is deleted or corrupted, it can be regenerated via the command ```samtools index {sample}.bam```.

### Output Files
- [≥1] ```{out_dir}/output/vectoring/{ref}/{first}-{last}/{sample}_report.txt``` Report in plain text format containing information about the vectoring of sample ```sample``` aligned to reference ```ref``` over the region from ```first``` to ```last```.
- [≥1] ```{out_dir}/output/vectoring/{ref}/{first}-{last}/{sample}/vectors_{num}.orc``` Mutation vectors in Apache ORC format. Each row is one mutation vector; each column is one position in the region from ```first``` to ```last```, inclusive (thus there are ```last - first + 1``` columns).

## Mutation vector format

### Encoding scheme for mutation vectors

Each element in a mutation vector indicates the possible mutation states at that position in the region. Each element is one byte that is the logical union of all possible states for that position in the mutation vector:
  - ```00000001```: match
  - ```00000010```: deletion
  - ```00000100```: insertion of ≥1 base(s) immediately 3' of this position
  - ```00001000```: insertion of ≥1 base(s) immediately 5' of this position
  - ```00010000```: substitution to A
  - ```00100000```: substitution to C
  - ```01000000```: substitution to G
  - ```10000000```: substitution to T

Additionally, ```00000000``` indicates that the mutation vector does not cover the position. For example, ```00000011``` means that the element of the mutation vector could be a match or deletion, and ```11110001``` means a match or any substitution. Note several important differences between the encoding of insertions and deletions:
- Every base deleted from the read results in one byte with a deletion bit (unless the deletion is ambiguous). Every insertion results in two bytes with an insertion bit: a 3' insertion bit set immediately upstream of the insertion (unless it occurs at the first position in the region) and a 5' insertion bit immediately downstream (unless the insertion occurs the last position in the region).
- A deletion bit indicates that the position is deleted from the read. However, insertion bits indicate that one or more bases are inserted 5' or 3' of the position but do not indicate anything about the position itself. Thus, every position with an insertion bit also has one or more bits indicating the state of the position itself. For example, if the reference is ```GACTA``` and the read is ```GACAATA``` (i.e. ```AA``` is inserted between the ```C``` and the ```T```), then the ```C``` will be ```00000101``` (a match with an insertion on its 3' side) and the ```T``` will be ```00001001``` (a match with an insertion on its 5' side). No information about the insertion (```AA```) is stored.
- For deletions, every base deleted from the read corresponds to one base in the reference, so the deleted bases (and read sequence) can be determined exactly given only the reference sequence and the mutation vector (unless the deletion is ambiguous). However, mutation vector files store only the location of an insertion, but not its length or sequence; not only is this information not needed for DREEM, but also storing it would require adding a special field of arbitrary size to the mutation vector, which would vastly complicate the code. Thus, the inserted bases (and read sequence) cannot be determined given only the reference sequence and the mutation vector.

### Ambiguous positions in mutation vectors

If, at a position in a mutation vector, one of several alternative mutations could have occured that would have generated the same read sequence, then an ambiguous encoding is used for the position. This encoding is the bitwise union of all possible states in which the position could exist. Several situations can cause ambiguous positions:

#### Low-quality base calls
Every base whose phred score is below the quality threshold is masked as an ```N``` before alignment. Since the reference cannot contain ```N```s, Bowtie2 calls each of these bases a substitution (i.e. ```X``` in the CIGAR string). When the vectoring module encodes each substitution, ```N``` positions could be either a match or substitution (since the base identity is unknown), so they are encoded as follows:
- If the reference base is ```A```: ```11100001``` (match or any substitution except A)
- If the reference base is ```C```: ```11010001``` (match or any substitution except C)
- If the reference base is ```G```: ```10110001``` (match or any substitution except G)
- If the reference base is ```T```: ```01110001``` (match or any substitution except T)

#### Deletions
A deletion that occurs amid bases of the same type is ambiguous. For example, if the reference is ```AGCTTG``` and the read is ```AGCTG```, it is clear that one ```T``` has been deleted from the read, but impossible to tell which. The one that is not deleted is a match (i.e. ```T``` = ```T```). Thus both positions 4 and 5 in the reference should be encoded ambiguously as a match or deletion (```00000011```).

If a deletion spans two or more consecutive bases, Bowtie2 will encode them all in the same deletion operation, e.g. mutating ```AGCTTG``` to ```ATTG``` would yield the CIGAR string ```1=2D3=```, corresponding to the read alignment ```AG--TG```. It is possible for one or more of these deletions to be ambiguous, for example ```AGCTTG``` could mutate to ```AGTG``` via either ```AG--TG``` or ```AG-T-G```. In a sequence alignment designed for phylogenetic analysis, where mutations are relatively rare, it is reasonable to assume that deleting two or more consecutive bases simultaneously is much more likely than deleting each separately, favoring the interpretation ```AG--TG```. However, when mutations are deliberately introduced at a relatively high frequency, as in DMS-MaPseq, getting the mutation ```AG--TG``` is not necessarily more likely than ```AG-T-G```. This ambiguity is more obvious if two consecutive homopolymers each contained one deletion, such as ```AAAAACCCCC``` mutating to ```AAAACCCC```. Any of the 5 ```A```s could be deleted, as well as any of the 5 ```C```s, and only one of these 25 possibilities is the consecutive deletion ```AAAA--CCCC```, the one that Bowtie2 would likely output.
